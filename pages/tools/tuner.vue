<template>
  <div id="tuner" class="tuner w-full px-3 md:px-0 md:w-4/5 lg:w-3/5">
    <div class="tuner-interface">
      <svg width="100%" height="270" viewBox="0 0 1000 270" xmlns="http://www.w3.org/2000/svg">
        <g id="tuner">
          <g id="tuner_2">
            <g id="display">
              <g class="medium-graduation">
                <path d="M45 90L45.0005 210" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M63.2226 120L63.2229 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M81.4455 120L81.4458 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M99.6682 120L99.6685 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M117.891 120L117.891 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M136 104L136.001 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M154.225 120L154.225 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M172.45 120L172.45 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M190.675 120L190.675 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M208.9 120L208.9 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M227.125 104L227.125 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M245.35 120L245.35 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M263.575 120L263.575 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M281.8 120L281.8 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M300.025 120L300.025 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M318.25 104L318.25 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M336.475 120L336.475 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M354.7 120L354.7 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M372.925 120L372.925 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M391.15 120L391.15 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M409.375 104L409.375 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M427.6 120L427.6 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M445.825 120L445.825 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M464.05 120L464.05 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M482.275 120L482.275 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="middle-graduation">
                <path d="M500.5 80L500.5 220" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M518.725 120L518.725 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M536.95 120L536.95 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M555.175 120L555.175 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M573.4 120L573.4 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M591.626 104L591.626 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M609.851 120L609.852 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M628.077 120L628.077 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M646.302 120L646.303 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M664.527 120L664.528 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M682.752 104L682.753 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M700.977 120L700.978 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M719.202 120L719.203 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M737.427 120L737.427 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M755.652 120L755.653 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M773.877 104L773.878 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M792.102 120L792.103 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M810.327 120L810.328 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M828.552 120L828.552 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M846.777 120L846.778 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M865.002 104L865.003 196" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M883.002 120L883.003 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M901.227 120L901.228 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M919.452 120L919.453 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="graduation">
                <path d="M937.677 120L937.678 180" stroke="#818181" stroke-linecap="round"/>
              </g>
              <g class="medium-graduation">
                <path d="M955.902 90L955.903 210" stroke="#818181" stroke-linecap="round"/>
              </g>
            </g>
            <g id="indicator">
              <path d="M45.0052 80L45.0059 222" stroke="#00E676" stroke-width="3" stroke-linecap="round" :transform="cursorPositionStyle"/>
            </g>
          </g>
          <g id="top indications">
            <text
              v-if="foundNote"
              class="graduation-text"
              xml:space="preserve"
              style="white-space: pre"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="45" y="58.8636" >{{ foundNote.frequency.toFixed(0) }} Hz</tspan>
            </text>
            <text
              class="text-4xl"
              :class="{
                'fill-error': precision === -2 || precision === 2,
                'fill-warning': precision === -1 || precision === 1,
                'fill-success': precision === 0,
              }"
              xml:space="preserve"
              style="white-space: pre"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="500.5" y="35" v-if="precision === 0">Perfect</tspan>
              <tspan x="500.5" y="35" v-else-if="precision === 1">High</tspan>
              <tspan x="500.5" y="35" v-else-if="precision === -1">Low</tspan>
              <tspan x="500.5" y="35" v-else-if="precision === 2">Too high</tspan>
              <tspan x="500.5" y="35" v-else-if="precision === -2">Too low</tspan>
            </text>
            <text
              v-if="foundNote"
              class="graduation-text"
              xml:space="preserve"
              style="white-space: pre"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="955.902" y="58.8636" >{{ foundNote.cents }} cents</tspan>
            </text>
          </g>
          <g id="bottom indications">
            <text
              class="graduation-text"
              xml:space="preserve"
              style="white-space: pre"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="45" y="251.864" >-50</tspan>
            </text>
            <text
              class="graduation-text"
              xml:space="preserve"
              style="white-space: pre"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="500.5" y="251.864" >0</tspan>
            </text>
            <text
              class="graduation-text"
              dominant-baseline="middle"
              text-anchor="middle"
            >
              <tspan x="955.902" y="251.864" >50</tspan>
            </text>
          </g>
        </g>
      </svg>

      <div class="mt-2 flex justify-center text-base-content font-bold text-8xl">{{ foundNote?.name || '-' }}</div>
    </div>

    <canvas
        class="absolute bottom-0 left-0 right-0 w-full h-1/4"
        ref="visualizer"
    />
  </div>
</template>

<script setup lang="ts">
import type {Note} from '@chordbook/tuner'
import {createTuner} from '@chordbook/tuner'
import type {Ref} from "vue";
import {useElementSize} from "@vueuse/core";

definePageMeta({
  title: 'Tuner'
})

useSEODescription("Your essential tool for precise tuning on the go. Keep your instrument in perfect pitch with ease.");

const tuner = createTuner({
  // The callback to call when a note is detected.
  onNote: note => {
    foundNote.value = note;

    cursorPosition.value = mapValueToPosition(note.cents);
  },

  // Here are some other settings you can fiddle with and their default values.
  // (let us know if you find values that work better).

  // The number of milliseconds between each pitch detection.
  updateInterval: 10,

  // The frequency of middle A. Defaults to 440Hz.
  a4: 440,

  // The minimum clarity threshold. Anything below this will be ignored
  clarityThreshold: 0.9,

  // The minimum volume threshold. -1000 means 1/1000th the volume of the loudest sound.
  minVolumeDecibels: -1000,

  // The minimum and maximum frequencies to detect. To reduce noise, everything else is
  // filtered out using a lowpass and highpass filter.
  minFrequency: 27.5, // A0, Lowest note on a piano
  maxFrequency: 4186.01, // C8, Highest note on a piano

  // The sample rate to use for the audio context.
  // https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/sampleRate
  sampleRate: 44100,

  // The size of buffer to use for frequency analysis, which maps to the `fftSize`:
  // https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/fftSize
  bufferSize: 8192,

  // https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode/smoothingTimeConstant
  smoothingTimeConstant: 0.8
})

function mapValueToPosition(value: number): number {
  const minValue = -50;
  const maxValue = 50;
  const minPosition = 0;
  const maxPosition = 910.902;

  // Ensure the value is within the expected range
  if (value < minValue) value = minValue;
  if (value > maxValue) value = maxValue;

  // Normalize the value to [0, 1]
  const normalizedValue = (value - minValue) / (maxValue - minValue);

  // Map the normalized value to [0, 910.902]
  return normalizedValue * (maxPosition - minPosition) + minPosition;
}

const graduationMarker = (i: number) => -40 + ((i - 1) * 5);
const isMultipleOf = (n: number, m: number) => n % m === 0;

const graduationsContainer = ref() as Ref<HTMLDivElement>;
const cursor = ref() as Ref<HTMLSpanElement>;
const {width} = useElementSize(graduationsContainer);

const cursorPosition = ref(0);
const cursorPositionStyle = computed(() => {
  console.log('computed ' + cursorPosition.value);
  return 'translate(' + cursorPosition.value + ')';
});

const precision = computed(() => {
  if (foundNote.value === null) return;
  if (foundNote.value.cents > -5 && foundNote.value.cents < 5) return 0;
  if (foundNote.value.cents <= -5 && foundNote.value.cents > -20) return -1;
  if (foundNote.value.cents >= 5 && foundNote.value.cents < 20) return 1;
  if (foundNote.value.cents < -20) return -2;
  if (foundNote.value.cents > 20) return 2;
})

const visualizer = ref() as Ref<HTMLCanvasElement>;
const foundNote = ref(null) as Ref<Note | null>;

const bufferLength = tuner.analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);
// Just get the low end of the spectrum
const displayLength = Math.sqrt(bufferLength) * 2;

function visualize() {
  const ctx = visualizer.value.getContext("2d")!;
  visualizer.value.width = visualizer.value.offsetWidth
  visualizer.value.height = visualizer.value.offsetHeight

  tuner.analyser.getByteFrequencyData(dataArray);

  ctx.clearRect(0, 0, visualizer.value.width, visualizer.value.height);

  const barWidth = (visualizer.value.width / displayLength);
  let x = 0;

  for (let i = 0; i < displayLength; i++) {
    const barHeight = (visualizer.value.height * (dataArray[i] / 255));

    ctx.fillStyle = `hsl(221, 83%, 55%)`;
    ctx.fillRect(x, visualizer.value.height - barHeight, barWidth, barHeight);

    x += barWidth;
  }
  requestAnimationFrame(visualize);
}

onMounted(() => {
  // Request access to the microphone and begin pitch detection
  tuner.start();

  // visualize();
})

onUnmounted(() => {
  // Stop pitch detection and release the microphone
  tuner.stop();
})
</script>

<style scoped lang="scss">
.needle-indicator {
  transition: all .1s ease-in-out;
}

.graduation {
  fill: oklch(var(--bc));
}

.graduation-text {
  fill: oklch(var(--bc));
}

.fill-success {
  fill: oklch(var(--su));
}

.fill-warning {
  fill: oklch(var(--wa));
}

.fill-error {
  fill: oklch(var(--er));
}
</style>