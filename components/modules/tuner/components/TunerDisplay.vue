<template>
  <svg
    v-if="width >= minDesktopWidth"
    width="100%"
    height="270"
    viewBox="0 0 1000 270"
    xmlns="http://www.w3.org/2000/svg"
  >
    <g id="tuner">
      <g id="tuner_2">
        <g id="display">
          <g class="medium-graduation">
            <path d="M45 90L45.0005 210" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M63.2226 120L63.2229 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M81.4455 120L81.4458 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M99.6682 120L99.6685 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M117.891 120L117.891 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M136 104L136.001 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M154.225 120L154.225 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M172.45 120L172.45 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M190.675 120L190.675 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M208.9 120L208.9 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M227.125 104L227.125 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M245.35 120L245.35 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M263.575 120L263.575 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M281.8 120L281.8 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M300.025 120L300.025 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M318.25 104L318.25 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M336.475 120L336.475 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M354.7 120L354.7 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M372.925 120L372.925 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M391.15 120L391.15 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M409.375 104L409.375 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M427.6 120L427.6 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M445.825 120L445.825 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M464.05 120L464.05 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M482.275 120L482.275 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="middle-graduation">
            <path d="M500.5 80L500.5 220" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M518.725 120L518.725 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M536.95 120L536.95 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M555.175 120L555.175 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M573.4 120L573.4 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M591.626 104L591.626 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M609.851 120L609.852 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M628.077 120L628.077 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M646.302 120L646.303 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M664.527 120L664.528 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M682.752 104L682.753 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M700.977 120L700.978 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M719.202 120L719.203 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M737.427 120L737.427 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M755.652 120L755.653 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M773.877 104L773.878 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M792.102 120L792.103 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M810.327 120L810.328 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M828.552 120L828.552 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M846.777 120L846.778 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M865.002 104L865.003 196" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M883.002 120L883.003 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M901.227 120L901.228 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M919.452 120L919.453 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="graduation">
            <path d="M937.677 120L937.678 180" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g class="medium-graduation">
            <path d="M955.902 90L955.903 210" stroke="#818181" stroke-linecap="round"/>
          </g>
        </g>
        <g id="indicator">
          <path
            d="M45.0052 80L45.0059 222"
            stroke-width="3"
            stroke-linecap="round"
            :transform="cursorPosition"
            class="needle-indicator"
            :class="{
              'fill-error': precision === -2 || precision === 2,
              'fill-warning': precision === -1 || precision === 1,
              'fill-success': precision === 0,
            }"
          />
        </g>
      </g>
      <g id="top indications">
        <text
          v-if="note"
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="45" y="58.8636" >{{ props.note?.frequency.toFixed(0) }} Hz</tspan>
        </text>
        <text
          class="text-4xl"
          :class="{
            'fill-error': precision === -2 || precision === 2,
            'fill-warning': precision === -1 || precision === 1,
            'fill-success': precision === 0,
          }"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="500.5" y="35" v-if="precision === 0">Perfect</tspan>
          <tspan x="500.5" y="35" v-else-if="precision === 1">High</tspan>
          <tspan x="500.5" y="35" v-else-if="precision === -1">Low</tspan>
          <tspan x="500.5" y="35" v-else-if="precision === 2">Too high</tspan>
          <tspan x="500.5" y="35" v-else-if="precision === -2">Too low</tspan>
        </text>
        <text
          v-if="note"
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="955.902" y="58.8636" >{{ props.note?.cents }} cents</tspan>
        </text>
      </g>
      <g id="bottom indications">
        <text
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
            <tspan x="45" y="251.864" >-50</tspan>
          </text>
        <text
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
            <tspan x="500.5" y="251.864" >0</tspan>
          </text>
        <text
          class="graduation-text"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="955.902" y="251.864" >50</tspan>
        </text>
      </g>
    </g>
  </svg>
  <svg v-else width="100%" height="320" viewBox="0 0 640 320" xmlns="http://www.w3.org/2000/svg">
    <g id="mobile tuner" clip-path="url(#clip0_56_2)">
      <g id="tuner">
        <g id="display">
          <g id="side graduation">
            <path d="M35.0008 253L35.0003 113" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M54.0013 223L54.001 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M73.0016 223L73.0012 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M92.0018 223L92.0015 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M111.002 223L111.002 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M130.003 223L130.002 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M149.003 223L149.003 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="medium graduation">
            <path d="M168.003 239L168.003 127" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M187.004 223L187.003 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M206.004 223L206.004 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M225.004 223L225.004 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M244.005 223L244.005 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M263.005 223L263.005 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M282.006 223L282.005 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M301.006 223L301.006 143" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="middle graduation">
            <path d="M320.006 103L320.007 263" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M339.007 143L339.007 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M358.007 143L358.007 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M377.007 143L377.008 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M396.008 143L396.008 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M415.008 143L415.009 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M434.009 143L434.009 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M453.009 143L453.009 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="medium graduation">
            <path d="M472.009 127L472.01 239" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M491.01 143L491.01 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M510.01 143L510.01 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M529.011 143L529.011 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M548.011 143L548.011 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M567.011 143L567.012 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="graduation">
            <path d="M586.012 143L586.012 223" stroke="#818181" stroke-linecap="round"/>
          </g>
          <g id="side graduation">
            <path d="M605.012 113L605.013 253" stroke="#818181" stroke-linecap="round"/>
          </g>

        </g>
        <g id="indicator">
          <path
            d="M35.0137 102L35.0144 264"
            stroke-width="3"
            stroke-linecap="round"
            :transform="cursorPosition"
            class="needle-indicator"
            :class="{
              'fill-error': precision === -2 || precision === 2,
              'fill-warning': precision === -1 || precision === 1,
              'fill-success': precision === 0,
            }"
          />
        </g>
      </g>
      <g id="top indications">
        <text
            v-if="note"
            class="graduation-text"
            xml:space="preserve"
            style="white-space: pre"
            dominant-baseline="middle"
            text-anchor="middle"
        >
          <tspan x="35.0008" y="80" >{{ props.note?.frequency.toFixed(0) }} Hz</tspan>
        </text>
        <text
            class="text-4xl"
            :class="{
            'fill-error': precision === -2 || precision === 2,
            'fill-warning': precision === -1 || precision === 1,
            'fill-success': precision === 0,
          }"
            xml:space="preserve"
            style="white-space: pre"
            dominant-baseline="middle"
            text-anchor="middle"
        >
          <tspan x="320.006" y="70" v-if="precision === 0">Perfect</tspan>
          <tspan x="320.006" y="70" v-else-if="precision === 1">High</tspan>
          <tspan x="320.006" y="70" v-else-if="precision === -1">Low</tspan>
          <tspan x="320.006" y="70" v-else-if="precision === 2">Too high</tspan>
          <tspan x="320.006" y="70" v-else-if="precision === -2">Too low</tspan>
        </text>
        <text
            v-if="note"
            class="graduation-text"
            xml:space="preserve"
            style="white-space: pre"
            dominant-baseline="middle"
            text-anchor="middle"
        >
          <tspan x="605.012" y="80" >{{ props.note?.cents }} cents</tspan>
        </text>

      </g>
      <g id="bottom indications">
        <text
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="35.0008" y="290" >-50</tspan>
        </text>
        <text
          class="graduation-text"
          xml:space="preserve"
          style="white-space: pre"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="320.006" y="290" >0</tspan>
        </text>
        <text
          class="graduation-text"
          dominant-baseline="middle"
          text-anchor="middle"
        >
          <tspan x="605.012" y="290" >50</tspan>
        </text>
      </g>
    </g>
  </svg>
</template>

<script lang="ts" setup>
import type {Note} from '@chordbook/tuner'
import {useWindowSize} from "@vueuse/core";

interface Props {
  note: Note | null;
}

const { width, height } = useWindowSize();
const minDesktopWidth = ref(1024);
const desktopTunerDisplayWidth = 910.902; // last right graduation (955.902) - first left graduation (45)
const mobileTunerDisplayWidth = 570.0112; // last right graduation (605.012) - first left graduation (35.0008)
const maxPosition = computed(() => {
  return width.value >= minDesktopWidth.value ? desktopTunerDisplayWidth : mobileTunerDisplayWidth;
});

const props = withDefaults(defineProps<Props>(), {
  note: null,
});

const precision = computed(() => {
  if (props.note === null) return;
  if (props.note.cents > -5 && props.note.cents < 5) return 0;
  if (props.note.cents <= -5 && props.note.cents > -20) return -1;
  if (props.note.cents >= 5 && props.note.cents < 20) return 1;
  if (props.note.cents < -20) return -2;
  if (props.note.cents > 20) return 2;
})

const cursorPosition = computed(() => {
  return 'translate(' + mapValueToPosition(props.note ? props.note.cents : 0) + ')';
});

function mapValueToPosition(value: number): number {
  const minValue = -50;
  const maxValue = 50;
  const minPosition = 0;

  // Ensure the value is within the expected range
  if (value < minValue) value = minValue;
  if (value > maxValue) value = maxValue;

  // Normalize the value to [0, 1]
  const normalizedValue = (value - minValue) / (maxValue - minValue);

  // Map the normalized value to [0, maxPossiblePosition]
  return normalizedValue * (maxPosition.value - minPosition) + minPosition;
}

</script>

<style scoped lang="scss">
.needle-indicator {
  transition: all .1s ease-in-out;
}

.graduation {
  fill: oklch(var(--bc));
}

.graduation-text {
  fill: oklch(var(--bc));
}

.fill-success {
  stroke: oklch(var(--su));
  fill: oklch(var(--su));
}

.fill-warning {
  stroke: oklch(var(--wa));
  fill: oklch(var(--wa));
}

.fill-error {
  stroke: oklch(var(--er));
  fill: oklch(var(--er));
}
</style>